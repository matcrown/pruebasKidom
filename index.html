<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OFICINA VIRTUAL - KIDOM ACADEMY</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="manifest" href="data:application/manifest+json,
    {
      'name': 'KiDOM Master Console',
      'short_name': 'KiDOM',
      'start_url': '.',
      'display': 'standalone',
      'background_color': '#f4f4f4',
      'theme_color': '#2667ff',
      'icons': [
        {
          'src': 'https://i.imgur.com/ZVERytB.png',
          'sizes': '512x512',
          'type': 'image/png'
        }
      ]
    }">
    <link rel="apple-touch-icon" href="https://i.imgur.com/Y0d87u3.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/Y0d87u3.png">
    <link rel="apple-touch-icon-precomposed" href="https://i.imgur.com/Y0d87u3.png">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #2667ff; --yellow: #FBBF24; --white: #ffffff; --dark: #1e293b; --red: #ef4444; --green-wa: #25d366; --exploradores: #4ade80; --lideres: #FBBF24; --campeones: #818cf8; }

        /* --- CORRECCI√ìN DE PANTALLA COMPLETA Y SCROLL --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            /* Permitimos el scroll pero ocultamos el rebote el√°stico */
            overflow-x: hidden;
            background-color: #f3f4f6;
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            display: flex; 
            flex-direction: column;
            /* Protege la zona de la bater√≠a/hora */
            padding-top: env(safe-area-inset-top);
            min-height: 100dvh; 
        }

        #main-app-container { 
            display: none; 
            width: 100%; 
            /* Altura din√°mica para evitar la barra blanca */
            min-height: 100dvh; 
            flex-direction: row; 
            /* Protege la zona de la barra de gestos inferior */
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        /* --- ANIMACI√ìN DE SALIDA LOGIN PROFESIONAL --- */
        .login-exit-anim { animation: loginExit 0.6s forwards ease-in-out; pointer-events: none; }
        @keyframes loginExit {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.25); opacity: 0; filter: blur(15px); }
        }

        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #f4f4f4;
            background-image: url("https://www.transparenttextures.com/patterns/felt.png"); 
            display: flex; align-items: center; justify-content: center; z-index: 99999; 
            overflow: hidden; transition: opacity 0.5s;
        }
        .polaroid {
            position: absolute; background: white; padding: 12px 12px 35px 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 3px; z-index: 2;
            filter: blur(2px); opacity: 0.85;
        }
        .polaroid img { width: 320px; height: 320px; object-fit: cover; border: 1px solid #eee; }
        .tack-gold { 
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            width: 25px; height: 25px; background: radial-gradient(circle at 35% 35%, #ffd700, #b8860b);
            border-radius: 50%; box-shadow: 2px 2px 6px rgba(0,0,0,0.4);
        }
        .p1 { top: -5%; left: -2%; transform: rotate(-12deg); }
        .p2 { top: -8%; right: -3%; transform: rotate(15deg); }
        .p3 { bottom: -5%; left: 0%; transform: rotate(10deg); }
        .p4 { bottom: -7%; right: -2%; transform: rotate(-15deg); }
        .p5 { top: 20%; left: 15%; transform: rotate(-5deg); }
        .p6 { top: 50%; right: 18%; transform: rotate(8deg); }
        .p7 { top: 0%; left: 35%; transform: rotate(5deg); }
        .p8 { bottom: -10%; left: 25%; transform: rotate(-10deg); }
        .p9 { top: 25%; left: 0%; transform: rotate(20deg); }
        .p10 { top: 20%; right: 1%; transform: rotate(-12deg); }
        .p11 { bottom: 50%; right: 25%; transform: rotate(12deg); }

        .login-card { 
            position: relative; z-index: 100;
            background: rgba(255, 255, 255, 0.3); 
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 40px; border-radius: 60px; width: 280px; text-align: center;
        display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center;
        text-align: center;
            box-shadow: 0 40px 80px rgba(0,0,0,0.15);
        }
        .login-input { width: 100%; padding: 10px; border-radius: 18px; border: none; margin-bottom: 10px; font-family: 'Montserrat'; font-weight: 800; text-align: center; outline: none; background: rgba(255,255,255,0.9); font-size: 15px; }
        .btn-login-go { width: 100%; padding: 15px; background: var(--yellow); border: none; border-radius: 10px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-family: 'Montserrat'; color: var(--dark); box-shadow: 0 10px 20px rgba(251, 191, 36, 0.4); }

      .sidebar { 
    width: 85px; 
    background: #ffffff; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    padding: 30px 0 20px 0; 
    gap: 20px; 
    border-right: 1px solid #e5e7eb; 
    position: relative;
    /* --- ANIMACI√ìN SUAVE --- */
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
    transform: translateX(0);
    opacity: 1;
}

/* Cuando se oculta, se desliza hacia la izquierda */
.sidebar.hidden-sidebar { 
    transform: translateX(-100%); 
    opacity: 0;
    width: 0; /* Para que no ocupe espacio al esconderse */
    padding: 0;
    border: none;
}      .sidebar.visible { width: 85px; }
        .filter-circle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: transparent; font-weight: 900; cursor: pointer; border: 2px solid #ccc; transition: 0.3s; font-size: 18px; color: #666; }
        .filter-circle.active.all { border-color: var(--blue); background: var(--blue); color: white; }
        .filter-circle.active.e { border-color: var(--exploradores); background: var(--exploradores); color: white; }
        .filter-circle.active.l { border-color: var(--lideres); background: var(--lideres); color: white; }
        .filter-circle.active.c { border-color: var(--campeones); background: var(--campeones); color: white; }

        .btn-logout-sidebar { margin-top: auto; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border: 2px solid #e2e8f0; cursor: pointer; font-size: 20px; transition: 0.3s; }
        .btn-logout-sidebar:hover { background: var(--red); color: white; border-color: var(--red); }
        .btn-logout-sidebar svg { stroke: #64748b; transition: 0.3s; }
        .btn-logout-sidebar:hover svg { stroke: white; }

        .main-content { flex: 1; display: flex; flex-direction: column; min-height: 100%; overflow-x: hidden; position: relative; }
        .header { background: var(--blue); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 900; text-transform: uppercase; font-size: 35px; flex-shrink: 0; }
        .header img { height: 45px; }
        .tabs { 
            display: flex; 
            background: #e5e7eb; 
            padding: 5px; 
            flex-shrink: 0; 
            overflow-x: auto; /* Activa deslizamiento horizontal */
            white-space: nowrap; /* Evita que los botones se amontonen */
            -webkit-overflow-scrolling: touch; /* Suavidad en iPhone */
            gap: 5px;
        }
        /* Oculta la barra de scroll para que se vea m√°s limpio */
        .tabs::-webkit-scrollbar { display: none; }

        .tab-btn { 
            flex: 0 0 auto; /* Importante: evita que los botones se encojan */
            padding: 15px 20px; 
            border: none; 
            font-weight: 800; 
            cursor: pointer; 
            border-radius: 12px; 
            background: transparent; 
            color: #64748b; 
            font-size: 19px; 
            text-transform: uppercase; 
        }
        .tab-btn.active { background: var(--yellow) !important; color: var(--dark) !important; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

       /* --- DISE√ëO DE TARJETA LARGA + M√ìDULOS DEBAJO --- */
        /* --- DISE√ëO DE CONSOLA ABIERTA (APEGADO A LA IZQUIERDA) --- */
        /* --- CONSOLA DE MANDO KIDOM (VERSION FINAL CORREGIDA) --- */
        /* --- AJUSTE DE POSICI√ìN: PARALELAS ABAJO --- */
        /* --- CONSOLA DE MANDO KIDOM (ESTRUCTURA T) --- */
        #registro { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            padding: 40px; 
            gap: 25px; 
            background-color: #f3f4f6;
        }

        .contenedor-inferior-apps {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 25px;
            width: 100%;
            max-width: 844px;
        }

        .bloque-registro {
            background: white;
            padding: 20px;
            border-radius: 25px;
            border-left: 10px solid var(--blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .bloque-identidad { max-width: 844px; border-left-color: var(--blue); }
        .bloque-mision { flex: 1; border-left-color: var(--yellow); }
        .bloque-pago { flex: 1; border-left-color: var(--dark); }

        .titulo-seccion-new {
            font-size: 13px; font-weight: 900; color: var(--dark);
            margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;
        }

        /* BOT√ìN MODAL HORARIOS */
        .btn-abrir-horarios {
            width: 100%; padding: 12px; margin-top: 5px;
            background: #f8fafc; border: 2px dashed #cbd5e1;
            border-radius: 12px; color: var(--blue); font-weight: 800;
            cursor: pointer; transition: 0.3s;
        }
        .btn-abrir-horarios:hover { background: #eff6ff; border-color: var(--blue); }

        /* ESTILO SELECT MODAL */
        .select-modal-asis {
            width: 100%; height: 250px !important; border: none;
            font-family: 'Montserrat'; font-weight: 700; font-size: 13px; outline: none;
        }
        .select-modal-asis option { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .select-modal-asis option:checked { background: var(--yellow) !important; color: var(--dark); }

        /* Contenedor para las dos tarjetas de abajo */
        .contenedor-inferior-apps {
            display: flex;
            flex-direction: row; /* Las pone una al lado de la otra */
            align-items: stretch; /* Mismo alto para ambas */
            gap: 25px;
            width: 100%;
            max-width: 844px; /* Ajusta seg√∫n prefieras el ancho */
        }

        .bloque-registro {
            background: white;
            padding: 15px;
            border-radius: 25px;
            border-left: 10px solid var(--blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        /* Identidad se queda al 100% del ancho del contenedor */
        .bloque-identidad { 
            width: 100%; 
            max-width: 800px; 
            border-left-color: var(--blue); 
        }

        /* Entrenamiento y Pago crecen igual */
        .bloque-mision { flex: 1; border-left-color: var(--yellow); }
        .bloque-pago { flex: 1; border-left-color: var(--dark); }

        @media (max-width: 900px) {
            .contenedor-inferior-apps { flex-direction: column; }
        }
        .form-container-wrapper { position: relative; padding: 25px; margin-top: 10px; flex-shrink: 0; }
        .tack { position: absolute; width: 22px; height: 22px; background: radial-gradient(circle at 35% 35%, #ffd700, #b8860b); border-radius: 50%; z-index: 100; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); }
        .tack-tl { top: 10px; left: 10px; } .tack-tr { top: 10px; right: 10px; } .tack-bl { bottom: 10px; left: 10px; } .tack-br { bottom: 10px; right: 10px; }
        .form-card { width: 440px; background: white; padding: 30px; border-radius: 40px; border: 2px solid var(--blue); text-align: center; position: relative; }
        .cost-card { width: 340px; background: white; padding: 30px; border-radius: 40px; border: 2px solid var(--blue); text-align: center; position: relative; }
        .label-kidom { display: block; margin-top: 12px; font-weight: 800; font-size: 11px; color: var(--blue); text-transform: uppercase; text-align: left; }
        .select-kidom { width: 100%; padding: 10px; margin-top: 4px; border-radius: 12px; border: 2px solid #f1f5f9; font-size: 14px; font-weight: 700; color: var(--dark); background: #ffffff; box-sizing: border-box; font-family: 'Montserrat'; outline: none; }
        .bank-info-box { background: #eff6ff; padding: 15px; border-radius: 15px; margin-top: 15px; text-align: left; border: 1px solid #bfdbfe; font-size: 11px; border-left: 5px solid var(--blue); color: var(--dark); line-height: 1.6; display: none; }
        .card-info-box { background: #fff7ed; padding: 15px; border-radius: 15px; margin-top: 15px; text-align: left; border: 1px solid #ffedd5; font-size: 11px; border-left: 5px solid #f97316; color: #9a3412; display: none; }
        .cost-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: 800; color: #64748b; }
        .cost-total { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #e2e8f0; font-size: 22px; font-weight: 900; color: var(--dark); }
        .btn-afiliar-kidom { width: 100%; margin-top: 20px; padding: 18px; font-weight: 900; background: var(--yellow) !important; color: var(--dark) !important; border: none; border-radius: 15px; cursor: pointer; text-transform: uppercase; font-size: 14px; }
        .btn-update-kidom { width: 100%; margin-top: 20px; padding: 18px; font-weight: 900; background: var(--dark) !important; color: white !important; border: none; border-radius: 15px; cursor: pointer; text-transform: uppercase; font-size: 14px; display: none; }

        #asistencia { display: none; flex: 1; padding: 20px; overflow-y: auto; }
        
        .grid-asis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding-right: 10px; }
        
        .card-asis { background: white; border-radius: 25px; padding: 15px; display: flex; align-items: center; gap: 15px; border: 2px solid #f1f5f9; position: relative; }
        .card-asis.Exploradores { border-color: var(--exploradores); }
        .card-asis.Lideres { border-color: var(--lideres); }
        .card-asis.Campeones { border-color: var(--campeones); }
        .foto-wrapper { position: relative; width: 70px; height: 70px; flex-shrink: 0; }
        .foto-est-asis { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid #eee; background: #eee; }
        .btn-salud-pesa { position: absolute; bottom: -5px; right: -5px; background: white; color: black; border: 2px solid var(--blue); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .asis-info { flex: 1; }
        .asis-info b { font-size: 14px; color: var(--blue); cursor: pointer; display: block; text-transform: uppercase; }
        .asis-info small { font-weight: 900; font-size: 11px; color: #64748b; }
        .asis-actions { display: flex; flex-direction: column; gap: 6px; }
        .btn-asistio-go { background: var(--blue); color: white; border: none; padding: 8px; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 10px; text-transform: uppercase; }
        .btn-wa-asis { background: var(--green-wa); color: white; border: none; padding: 8px; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 10px; text-decoration: none; color: white; display: flex; align-items: center; justify-content: center; }

        #calendario { display: none; flex: 1; overflow: auto; padding: 20px; }
        .semana-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; min-width: 1000px; }
        .dia-col { background: white; border-radius: 18px; padding: 12px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .dia-header { background: var(--blue); color: white; text-align: center; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 900; text-transform: uppercase; }
        .turno-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px; border-radius: 10px; min-height: 45px; }
        .turno-time { font-size: 10px; font-weight: 900; color: var(--blue); margin-bottom: 5px; display: block; border-bottom: 1px solid #eee; }
        .estudiante-tag { font-size: 10px; padding: 4px 8px; border-radius: 6px; color: white; margin-bottom: 3px; display: block; font-weight: 800; cursor: pointer; text-align: center; text-transform: uppercase; }
        #canvasFirma { background: #f1f5f9; border: 2px dashed #ccc; border-radius: 15px; width: 100%; height: 180px; touch-action: none; }
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 100000; align-items:center; justify-content:center; }
        .modal-box { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 380px; text-align: center; }

        @media (max-width: 1024px) {
            #registro[style*="display: flex"], 
            #registro[style*="display:flex"] { 
                flex-direction: column !important; 
                align-items: center !important; 
                overflow-y: visible !important;
                height: auto !important;
                padding-bottom: 100px !important;
            }

            .form-container-wrapper {
                width: auto !important;
                max-width: 95% !important;
                display: inline-block !important;
                margin: 10px auto !important;
            }

            .form-card, .cost-card { 
                width: 100% !important; 
                max-width: 380px !important; 
                box-sizing: border-box !important;
            }

            .header { font-size: 16px !important; padding: 10px !important; }
            .header span { text-align: center; }
            .grid-asis { grid-template-columns: 1fr !important; }
            
            /* Scroll activado para m√≥vil */
            html, body { overflow-y: auto !important; }
            #main-app-container { height: auto !important; min-height: 100dvh; }

            /* PARCHE DE TRANSPARENCIA */
            #sel-horario {
                background: transparent !important;
                border: 2px solid rgba(38, 103, 255, 0.2) !important;
                color: var(--dark) !important;
                backdrop-filter: blur(5px);
                outline: none !important;
                -webkit-appearance: none;
            }

            #sel-horario option { background: white !important; color: var(--dark) !important; }
            #sel-horario:focus { background: transparent !important; }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="polaroid p1"><div class="tack-gold"></div><img src="https://i.imgur.com/wgRSAm5.png"></div>
    <div class="polaroid p2"><div class="tack-gold"></div><img src="https://i.imgur.com/9RFqBpW.jpeg"></div>
    <div class="polaroid p3"><div class="tack-gold"></div><img src="https://i.imgur.com/r0V0SAT.jpeg"></div>
    <div class="polaroid p4"><div class="tack-gold"></div><img src="https://i.imgur.com/BoHQKTQ.jpeg"></div>
    <div class="polaroid p5"><div class="tack-gold"></div><img src="https://i.imgur.com/jNaHsKa.jpeg"></div>
    <div class="polaroid p6"><div class="tack-gold"></div><img src="https://i.imgur.com/vWChTtr.jpeg"></div>
    <div class="polaroid p7"><div class="tack-gold"></div><img src="https://i.imgur.com/19T2j4K.jpeg"></div>
    <div class="polaroid p8"><div class="tack-gold"></div><img src="https://i.imgur.com/SEk9KlI.jpeg"></div>
    <div class="polaroid p9"><div class="tack-gold"></div><img src="https://i.imgur.com/Xis8ub1.png"></div>
    <div class="polaroid p10"><div class="tack-gold"></div><img src="https://i.imgur.com/WLJXedN.png"></div>
    <div class="polaroid p11"><div class="tack-gold"></div><img src="https://i.imgur.com/vOTT1fE.png"></div>
    <div class="login-card">
        <img src="https://i.imgur.com/TffJPDG.png" width="180" style="margin-bottom: 25px;">
        <input type="text" id="user" class="login-input" placeholder="USUARIO">
        <input type="password" id="pass" class="login-input" placeholder="CONTRASE√ëA CORPORATIVA">
        <button class="btn-login-go" onclick="validarAcceso()">INICIAR SESION</button>
    </div>
</div>

<div id="main-app-container">
    <div class="sidebar" id="sidebar">
        <div class="filter-circle active all" onclick="filterGroup('all', this)">ALL</div>
        <div class="filter-circle e" onclick="filterGroup('Exploradores', this)">E</div>
        <div class="filter-circle l" onclick="filterGroup('Lideres', this)">L</div>
        <div class="filter-circle c" onclick="filterGroup('Campeones', this)">C</div>
        <button class="btn-logout-sidebar" onclick="cerrarSesion()" title="Cerrar Sesi√≥n">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        </button>
    </div>
    <div class="main-content">
        <div class="header"><img src="https://i.imgur.com/bls27zm.png"><span>OFICINA VIRTUAL - KIDOM ACADEMY</span><img src="https://i.imgur.com/bls27zm.png"></div>
        <div class="tabs">
            <button class="tab-btn active" id="btn-registro" onclick="showTab('registro')">PROCESO DE AFILIACION KIDOM</button>
            <button class="tab-btn" id="btn-asistencia" onclick="showTab('asistencia')">REGISTRO DE ASISTENCIA</button>
            <button class="tab-btn" id="btn-calendario" onclick="showTab('calendario')">Calendario DE SESIONES KIDOM</button>
            <button class="tab-btn" id="btn-dashboard" onclick="showTab('dashboard')">CONTABILIDAD MENSUAL</button>
        </div>
        
       <div id="registro" style="display: flex;">
    <div class="bloque-registro bloque-identidad">
        <div class="titulo-seccion-new">üë§ Identificaci√≥n del L√≠der</div>
        <div style="display: flex; gap: 30px; align-items: center;">
            <div style="text-align:center;">
                <img id="visor-foto-new" src="https://i.imgur.com/Y0d87u3.png" style="width: 100px; height: 100px; border-radius: 20px; object-fit: cover; border: 3px solid var(--blue);">
            </div>
            <div style="flex: 1;">
                <form id="formReg" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div><label class="label-kidom">Link Foto</label><input type="text" id="f_foto_url" class="select-kidom" placeholder="https://..." oninput="document.getElementById('visor-foto-new').src=this.value"></div>
                    <div><label class="label-kidom">Nombre Estudiante</label><input type="text" id="f_nombre" class="select-kidom" required></div>
                    <div><label class="label-kidom">Representante</label><input type="text" id="f_rep" class="select-kidom" required></div>
                    <div><label class="label-kidom">WhatsApp</label><input type="tel" id="f_wa" class="select-kidom" placeholder="57..." required></div>
                    <div style="grid-column: span 2;"><label class="label-kidom">Correo Oficial</label><input type="email" id="f_correo_padre" class="select-kidom" required></div>
                </form>
            </div>
        </div>
    </div>

    <div class="contenedor-inferior-apps">
        <div class="bloque-registro bloque-mision">
            <div class="titulo-seccion-new">‚öîÔ∏è Entrenamiento</div>
            <label class="label-kidom">Grupo</label>
            <select id="sel-grupo" class="select-kidom" onchange="actualizarHorarios()" required>
                <option value="">Seleccionar...</option>
                <option value="Exploradores">Exploradores</option>
                <option value="Lideres">Lideres</option>
                <option value="Campeones">Campeones</option>
            </select>
            <label class="label-kidom">Plan KiDOM</label>
            <select id="f_plan" class="select-kidom" onchange="calcularTotales()">
                <option value="Pro">Pro</option>
                <option value="Max">Max</option>
                <option value="Elite">Elite</option>
            </select>
            <label class="label-kidom">Duraci√≥n</label>
            <select id="f_dur" class="select-kidom" onchange="calcularTotales()">
                <option value="Mensual">Mensual</option>
                <option value="Trimestral">Trimestral</option>
                <option value="Trimestral PROMO">Trimestral PROMO</option>
                <option value="Anual">Anual</option>
                <option value="Anual PROMO">Anual PROMO</option>
            </select>
            <label class="label-kidom">Horarios Asignados</label>
            <button type="button" class="btn-abrir-horarios" onclick="document.getElementById('modalHorarios').style.display='flex'">üìÖ SELECCIONAR SESIONES</button>
            <select id="sel-horario" multiple style="display:none;"></select>
        </div>

        <div class="bloque-registro bloque-pago">
            <div class="titulo-seccion-new">üí∞ Facturaci√≥n</div>
            <label class="label-kidom">M√©todo</label>
            <select id="p-metodo" class="select-kidom" onchange="gestionarMetodoPago()">
                <option value="Efectivo">Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Tarjeta">Tarjeta (Payphone)</option>
            </select>
            <div id="div-bancos" style="display:none; margin-top:5px;">
                <select id="sel-banco" class="select-kidom" onchange="mostrarInfoBanco()"><option value="">Banco...</option><option value="Pichincha">Pichincha</option><option value="Austro">Austro</option><option value="JEP">JEP</option><option value="Jardin">Jardin Azuayo</option></select>
                <div id="info-banco" class="bank-info-box"></div>
            </div>
            <button id="btn-link-pago" class="select-kidom" style="background:var(--blue); color:white; font-weight:900; display:none; margin-top:10px;" onclick="abrirLinkTarjeta()">üõí LINK DE PAGO</button>

            <div style="margin-top: auto; border-top: 1px dashed #eee; padding-top: 15px;">
                <div class="cost-row">Subtotal: <span id="txt-sub">$0.00</span></div>
                <div class="cost-row">IVA (15%): <span id="txt-iva">$0.00</span></div>
                <div class="cost-row" id="row-recargo" style="display:none; color: #f97316;">Recargo Tarjeta: <span id="txt-recargo">$0.00</span></div>
                <div class="cost-total" style="border:none; padding:0; font-size: 26px; margin-top:5px;">TOTAL: <span id="res-tot">$65.00</span></div>
            </div>
            <button type="button" id="btn-afiliar-main" class="btn-afiliar-kidom" onclick="ejecutarAccion('register')" style="margin-top:10px;">üöÄ AFILIAR</button>
            <button type="button" id="btn-update-main" class="btn-update-kidom" onclick="ejecutarAccion('asistencia')" style="margin-top:10px;">üíæ GUARDAR</button>
        </div>
    </div>
</div>
        
        <div id="asistencia">
            <div style="margin-bottom: 20px; position: relative; max-width: 500px;">
                <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #64748b;">üîç</span>
                <input type="text" id="inputBusqueda" placeholder="BUSCAR L√çDER POR NOMBRE..." 
                       style="width: 100%; padding: 15px 15px 15px 45px; border-radius: 20px; border: 2px solid var(--blue); font-family: 'Montserrat'; font-weight: 800; font-size: 14px; outline: none; box-sizing: border-box;"
                       onkeyup="buscarEstudiante()">
            </div>
            <div class="grid-asis" id="grid-asis"></div>
        </div>
        <div id="calendario"><div class="semana-grid" id="semana-body"></div></div>

        <div id="dashboard" style="display: none; flex: 1; padding: 25px; background: #f3f4f6; overflow-y: auto;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <h2 style="color: var(--blue); font-weight: 900; margin: 0; text-transform: uppercase; letter-spacing: 1px;">REPORTE FINANCIERO KIDOM ACADEMY</h2>
        
        <div style="display: flex; align-items: center; gap: 10px;">
            <small style="font-weight: 800; color: #64748b;">SELECCIONE UN MES:</small>
            <select id="select-mes-dashboard" onchange="cargarDashboardDirecto()" style="padding: 12px 25px; border-radius: 15px; border: 2px solid var(--blue); font-family: 'Montserrat'; font-weight: 900; color: var(--blue); cursor: pointer; outline: none; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <option value="enero">ENERO</option>
                <option value="febrero">FEBRERO</option>
                <option value="marzo">MARZO</option>
                <option value="abril">ABRIL</option>
                <option value="mayo">MAYO</option>
                <option value="junio">JUNIO</option>
                <option value="julio">JULIO</option>
                <option value="agosto">AGOSTO</option>
                <option value="septiembre">SEPTIEMBRE</option>
                <option value="octubre">OCTUBRE</option>
                <option value="noviembre">NOVIEMBRE</option>
                <option value="diciembre">DICIEMBRE</option>
            </select>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <div style="background: white; padding: 20px; border-radius: 20px; border-left: 8px solid var(--blue); box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <small style="color: #64748b; font-weight: 800; font-size: 10px;">INGRESOS TOTALES DEL MES</small>
            <div id="dash-total" style="font-size: 28px; font-weight: 900; color: var(--dark);">$0.00</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 20px; border-left: 8px solid #f59e0b; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <small style="color: #64748b; font-weight: 800; font-size: 10px;">VALOR MEMBRESIA PROMEDIO</small>
            <div id="dash-promedio" style="font-size: 28px; font-weight: 900; color: var(--dark);">$0.00</div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 20px; border-left: 8px solid var(--exploradores); box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <small style="color: #64748b; font-weight: 800; font-size: 10px;">AFILIACIONES REGISTRADAS EN EL MES</small>
            <div id="dash-alumnos" style="font-size: 28px; font-weight: 900; color: var(--dark);">0</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
        <div style="background: white; padding: 25px; border-radius: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; font-size: 12px; font-weight: 800; color: var(--dark);">PROGRESO DE META MENSUAL</h4>
                <span id="txt-porcentaje-meta" style="font-weight: 900; color: var(--blue);">0%</span>
            </div>
            <div style="width: 100%; background: #eee; height: 25px; border-radius: 50px; overflow: hidden; position: relative;">
                <div id="bar-meta" style="width: 0%; background: linear-gradient(90deg, var(--blue), #60a5fa); height: 100%; transition: 1.5s ease-in-out;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; font-weight: 800;">
                <span style="color: #64748b;">VAMOS PARA ADELANTE KIDOM</span>
                <span style="color: var(--blue);">META: $4.000</span>
            </div>
        </div>

        <div style="background: white; padding: 25px; border-radius: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 15px 0; font-size: 12px; font-weight: 800; color: var(--dark);">FLUJO POR M√âTODO DE PAGO</h4>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <small style="font-size: 9px; font-weight: 800; color: #64748b;">EFECTIVO EN CAJA</small>
                    <div id="p-efe" style="font-weight: 900; color: #10b981; font-size: 20px;">$0</div>
                </div>
                <div>
                    <small style="font-size: 9px; font-weight: 800; color: #64748b;">TRANSFERENCIA BANCARIA</small>
                    <div id="p-tra" style="font-weight: 900; color: var(--blue); font-size: 20px;">$0</div>
                </div>
                <div>
                    <small style="font-size: 9px; font-weight: 800; color: #64748b;">TARJETA DE CREDITO</small>
                    <div id="p-tar" style="font-weight: 900; color: #f59e0b; font-size: 20px;">$0</div>
                </div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div style="background: white; padding: 25px; border-radius: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 20px 0; font-size: 12px; font-weight: 800; color: var(--dark); border-bottom: 2px solid #f8fafc; padding-bottom: 10px;">POPULARIDAD DE PLANES</h4>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 800;"><span>PLAN PRO - 2 SESIONES SEMANALES</span><span id="txt-p-pro">0</span></div>
                    <div style="width: 100%; background: #eee; height: 10px; border-radius: 10px; margin-top:5px;"><div id="bar-p-pro" style="width: 0%; background: var(--blue); height: 100%; transition: 1s;"></div></div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 800;"><span>PLAN MAX - 3 SESIONES SEMANALES</span><span id="txt-p-max">0</span></div>
                    <div style="width: 100%; background: #eee; height: 10px; border-radius: 10px; margin-top:5px;"><div id="bar-p-max" style="width: 0%; background: var(--yellow); height: 100%; transition: 1s;"></div></div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 800;"><span>PLAN ELITE - 5 SESIONES SEMANALES</span><span id="txt-p-elite">0</span></div>
                    <div style="width: 100%; background: #eee; height: 10px; border-radius: 10px; margin-top:5px;"><div id="bar-p-elite" style="width: 0%; background: var(--dark); height: 100%; transition: 1s;"></div></div>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 25px; border-radius: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 20px 0; font-size: 12px; font-weight: 800; color: var(--dark); border-bottom: 2px solid #f8fafc; padding-bottom: 10px;">AFILIACIONES REGISTRADAS POR GRUPO</h4>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 800;"><span>EXPLORADORES - 3 A 6 A√ëOS</span><span id="txt-g-exploradores">0</span></div>
                    <div style="width: 100%; background: #eee; height: 10px; border-radius: 10px; margin-top:5px;"><div id="bar-g-exploradores" style="width: 0%; background: #22c55e; height: 100%; transition: 1s;"></div></div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 800;"><span>L√çDERES - 7 A 10 A√ëOS</span><span id="txt-g-lideres">0</span></div>
                    <div style="width: 100%; background: #eee; height: 10px; border-radius: 10px; margin-top:5px;"><div id="bar-g-lideres" style="width: 0%; background: #3b82f6; height: 100%; transition: 1s;"></div></div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 800;"><span>CAMPEONES - 11 A 14 A√ëOS</span><span id="txt-g-campeones">0</span></div>
                    <div style="width: 100%; background: #eee; height: 10px; border-radius: 10px; margin-top:5px;"><div id="bar-g-campeones" style="width: 0%; background: #ef4444; height: 100%; transition: 1s;"></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalFirma"><div class="modal-box"><h3>FIRMA ASISTENCIA</h3><canvas id="canvasFirma"></canvas><button style="width:100%; padding:15px; border-radius:12px; border:none; font-weight:900; background:var(--blue); color:white; cursor:pointer;" onclick="confirmarAsistia()">FIRMAR ASISTENCIA</button><button style="width:100%; padding:15px; border-radius:12px; border:none; font-weight:900; background:#eee; cursor:pointer; margin-top:10px;" onclick="cerrarModal('modalFirma')">CANCELAR</button></div></div>
<div class="modal-overlay" id="modalSalud"><div class="modal-box"><h3>FICHA M√âDICA KiDOM</h3><input type="text" id="m_est" class="select-kidom" placeholder="Estatura (cm)"><input type="text" id="m_pes" class="select-kidom" placeholder="Peso (kg)"><input type="text" id="m_ale" class="select-kidom" placeholder="Alergias"><textarea id="m_dia" class="select-kidom" placeholder="Diagn√≥sticos" style="height:80px;"></textarea><button style="width:100%; padding:15px; border-radius:12px; border:none; font-weight:900; background:var(--dark); color:white; margin-top:10px;" onclick="cerrarModal('modalSalud')">GUARDAR DATOS</button></div></div>

<script>
    const URL_APP = "https://script.google.com/macros/s/AKfycbznzbI3xbNS6Ar-cVU5K1HYJtZ9EIzETmyzZEtlXzROpZrAVfW9MAoi5KiYxW-brSQPMA/exec";
    const LP = { Pro: { Mensual: "https://ppls.me/oYO7HdAY2uDaitKIp17hhQ", Trimestral: "https://ppls.me/WsTmdkuB5Trm4RvjzZ5HWg", Anual: "https://ppls.me/8IjkNd6NERmhQYk5al79A" }, Max: { Mensual: "https://ppls.me/wUQ10WYSVVnhPfg2EoYYhA", Trimestral: "https://ppls.me/gyKLQ1wx5FwpawZtoa9g", Anual: "https://ppls.me/gm9M9Q3KRe1497DJ3UiwQ" }, Elite: { Mensual: "https://ppls.me/Fvgd6XbcxNS8IRh1dBzUg", Trimestral: "https://ppls.me/YcioHxRcjCb7ESRyYOq0Q", Anual: "https://ppls.me/ezelM50M8JzDyAFtR5HZgg" } };
    const DB = { Pichincha: "Misael Carri√≥n<br>CI: 0105737324<br>Ahorros: 2201732707", Austro: "Misael Carri√≥n<br>CI: 0105737324<br>Ahorros: 3000867844", JEP: "Misael Carri√≥n<br>CI: 0105737324<br>Ahorros: 406068325001", Jardin: "Misael Carri√≥n<br>CI: 0105737324<br>Ahorros: 2497049" };

    let allStudents = []; let currentKidName = null;

    async function loadData() {
        try {
            const res = await fetch(URL_APP + "?action=read");
            const data = await res.json();
            allStudents = data.map(s => ({ 
                nombre: s.nombre, 
    rep: s.representante, 
    grupo: s.grupo, 
    clases: parseInt(s.sesiones) || 0, 
    wa: s.whatsapp, 
    horarios: s.horarios || "", 
    foto: s.foto || "",
    correoPadre: s.correoPadre,
    monto: s.monto,
    mes: s.mes,
    metodoPago: s.metodo,
    plan: s.plan // <--- ESTO DEBE ESTAR AQU√ç PARA QUE EL DASHBOARD LO LEA
            }))
            .sort((a, b) => a.nombre.localeCompare(b.nombre));
            renderAsistencia(); renderCalendario();
        } catch(e){}
    }

    function renderAsistencia(filter = 'all') {
        const grid = document.getElementById('grid-asis'); grid.innerHTML = '';
        if(document.getElementById('inputBusqueda')) document.getElementById('inputBusqueda').value = '';
        allStudents.filter(k => filter === 'all' || k.grupo === filter).forEach((k) => {
            grid.innerHTML += `<div class="card-asis ${k.grupo}"><div class="foto-wrapper"><img src="${k.foto || 'https://via.placeholder.com/70'}" class="foto-est-asis"><button class="btn-salud-pesa" onclick="document.getElementById('modalSalud').style.display='flex'">üèãÔ∏è</button></div><div class="asis-info"><b onclick="abrirReporte('${k.nombre}')" style="color:var(--blue); text-decoration:underline;">${k.nombre}</b><small>${k.clases} CLASES RESTANTES</small></div><div class="asis-actions"><button class="btn-asistio-go" onclick="abrirFirma('${k.nombre}')">FIRMAR</button><button class="btn-wa-asis" onclick="enviarWA('${k.nombre}','${k.rep}','${k.wa}')">CONFIRMAR</button></div></div>`;
        });
    }

    function renderCalendario(filter = 'all') {
        const body = document.getElementById('semana-body');
        const diasT = ["LUN", "MAR", "MIE", "JUE", "VIE", "SAB"], diasN = ["LUNES", "MARTES", "MI√âRCOLES", "JUEVES", "VIERNES", "S√ÅBADO"], horas = ["09H", "10H", "11H", "12H", "15H", "16H", "17H", "18H", "19H"];
        body.innerHTML = diasN.map((dn, i) => {
            let col = `<div class="dia-col"><div class="dia-header">${dn}</div>`;
            horas.forEach(h => {
                let tag = `${diasT[i]}_${h}`;
                let kids = allStudents.filter(s => s.horarios.includes(tag) && (filter==='all' || s.grupo===filter));
                if(kids.length > 0) col += `<div class="turno-box"><span class="turno-time">${h}00</span>${kids.map(k => `<span class="estudiante-tag" style="background:var(--${k.grupo.toLowerCase().replace('√≠','i')})" onclick="enviarWA('${k.nombre}','${k.rep}','${k.wa}')">${k.nombre.toUpperCase()}</span>`).join('')}</div>`;
            }); return col + `</div>`;
        }).join('');
    }

    async function ejecutarAccion(modo) {
    const btn = (modo === 'register') ? document.getElementById('btn-afiliar-main') : document.getElementById('btn-update-main');
    const originalText = btn.innerText;
    btn.innerText = "PROCESANDO..."; btn.disabled = true;

    // Capturamos el Plan y el M√©todo de los SELECTS correctos
    const valPlan = document.getElementById('f_plan').value;
    const valMetodo = document.getElementById('p-metodo').value;
    const valMonto = document.getElementById('res-tot').innerText.replace('$', '').trim();

    const h = Array.from(document.getElementById('sel-horario').selectedOptions).map(o => o.value).join(',');
    
    // Construimos la URL asegur√°ndonos que coincida con el .gs
    const query = `?action=${modo}` +
        `&nombre=${encodeURIComponent(document.getElementById('f_nombre').value)}` +
        `&representante=${encodeURIComponent(document.getElementById('f_rep').value)}` +
        `&correoPadre=${encodeURIComponent(document.getElementById('f_correo_padre').value)}` +
        `&grupo=${encodeURIComponent(document.getElementById('sel-grupo').value)}` +
        `&whatsapp=${encodeURIComponent(document.getElementById('f_wa').value)}` +
        `&monto=${encodeURIComponent(valMonto)}` +
        `&plan=${encodeURIComponent(valPlan)}` +   // Enviamos 'plan'
        `&metodo=${encodeURIComponent(valMetodo)}` + // Enviamos 'metodo'
        `&horarios=${encodeURIComponent(h)}` +
        `&sesiones=12` + // O el c√°lculo que tengas
        `&foto=${encodeURIComponent(document.getElementById('f_foto_url').value)}`;
    
    try { 
        await fetch(URL_APP + query, { method: 'GET', mode: 'no-cors' }); 
        alert("¬°REGISTRO EXITOSO!"); 
        limpiarForm();
        loadData(); 
    } catch(e){
        alert("Error al registrar, pero el proceso se inici√≥.");
    } finally { 
        btn.innerText = originalText; 
        btn.disabled = false; 
    }
}

    function limpiarForm() {
        document.getElementById('formReg').reset();
        document.getElementById('btn-afiliar-main').style.display = 'block';
        document.getElementById('btn-update-main').style.display = 'none';
        calcularTotales();
    }

    function editarHorarios(nombre) { 
        const kid = allStudents.find(s => s.nombre === nombre); 
        if(!kid) return; 
        showTab('register'); 
        document.getElementById('f_nombre').value = kid.nombre; 
        document.getElementById('f_rep').value = kid.rep; 
        document.getElementById('f_correo_padre').value = kid.correoPadre || "";
        document.getElementById('sel-grupo').value = kid.grupo; 
        document.getElementById('f_wa').value = kid.wa; 
        document.getElementById('f_foto_url').value = kid.foto;
        actualizarHorarios();
        document.getElementById('btn-afiliar-main').style.display = 'none';
        document.getElementById('btn-update-main').style.display = 'block';
    }

   function actualizarHorarios() { 
        const sel = document.getElementById('sel-horario'); 
        const selModal = document.getElementById('sel-horario-modal');
        
        // Limpiamos ambos
        sel.innerHTML = ''; 
        if(selModal) selModal.innerHTML = ''; 
        
        const g = document.getElementById('sel-grupo').value; 
        const HM = { 
            Exploradores: ["LUN_15H", "LUN_18H", "MAR_15H", "MAR_18H", "MIE_16H", "JUE_16H", "JUE_18H", "VIE_15H", "VIE_18H", "SAB_09H", "SAB_10H", "SAB_11H", "SAB_12H"], 
            Lideres: ["LUN_17H", "MAR_16H", "MIE_17H", "MIE_18H", "JUE_17H", "VIE_17H", "SAB_09H", "SAB_10H", "SAB_11H", "SAB_12H"], 
            Campeones: ["LUNES - 16H00PM", "LUNES - 19H00PM", "MARTES - 17H00PM", "MIERCOLES - 17H00PM", "MIERCOLES - 19H00PM", "JUEVES - 19H00PM", "VIERNES - 16H00PM", "VIERNES - 19H00PM", "SABADO - 09H00AM", "F.A SABADO - 10H00AM", "F.A SABADO - 11H00AM", "F.A SABADO - 12H00PM"] 
        };

        if(HM[g]) {
            HM[g].forEach(h => { 
                // Crear opci√≥n para el select oculto
                const o = document.createElement('option'); 
                o.value = h; 
                o.innerText = h.replace('_',' - ') + (h.includes('_') ? "00" : ""); 
                sel.appendChild(o);

                // IMPORTANTE: Crear una copia para el modal
                if(selModal) {
                    const oModal = o.cloneNode(true);
                    selModal.appendChild(oModal);
                }
            });
        }
    }

    function sincronizarHorarios() {
        const modalSelect = document.getElementById('sel-horario-modal');
        const realSelect = document.getElementById('sel-horario');
        
        if(!modalSelect || !realSelect) return;

        // Recorremos el modal y aplicamos la misma selecci√≥n al oculto
        for (let i = 0; i < modalSelect.options.length; i++) {
            if (realSelect.options[i]) {
                realSelect.options[i].selected = modalSelect.options[i].selected;
            }
        }
        
        // Llamamos a calcular totales por si el precio depende del n√∫mero de horas
        if(typeof calcularTotales === "function") calcularTotales();
    }
    
    function calcularTotales() { 
        const p = document.getElementById('f_plan').value, d = document.getElementById('f_dur').value, m = document.getElementById('p-metodo').value; 
        const pr = { Pro:{Mensual:65, Trimestral:180, "Trimestral PROMO":180, Anual:620}, Max:{Mensual:85, Trimestral:230, "Trimestral PROMO":230, Anual:880}, Elite:{Mensual:115, Trimestral:320, "Trimestral PROMO":320, Anual:1200} }; 
        let base = pr[p][d] || 65, rec = (m==='Tarjeta')?base*0.06:0; 
        document.getElementById('row-recargo').style.display=(m==='Tarjeta')?'flex':'none'; document.getElementById('txt-recargo').innerText=`$${rec.toFixed(2)}`; 
        const sub=base/1.15; document.getElementById('txt-sub').innerText=`$${sub.toFixed(2)}`; document.getElementById('txt-iva').innerText=`$${(base-sub).toFixed(2)}`; 
        document.getElementById('res-tot').innerText=`$${(base+rec).toFixed(2)}`; 
    }

    function gestionarMetodoPago() { const m = document.getElementById('p-metodo').value; document.getElementById('div-bancos').style.display=(m==='Transferencia')?'block':'none'; document.getElementById('btn-link-pago').style.display=(m==='Tarjeta')?'block':'none'; document.querySelector('.card-info-box').style.display=(m==='Tarjeta')?'block':'none'; calcularTotales(); }
    function mostrarInfoBanco() { const b = document.getElementById('sel-banco').value; document.getElementById('info-banco').innerHTML = b ? DB[b] : ''; document.getElementById('info-banco').style.display = b ? 'block' : 'none'; }
    function abrirLinkTarjeta() { const p = document.getElementById('f_plan').value, d = document.getElementById('f_dur').value.split(' ')[0]; if(LP[p] && LP[p][d]) window.open(LP[p][d], '_blank'); }
    
    function showTab(t) { 
        // 1. Ocultar todas las secciones
        ['registro', 'asistencia', 'calendario', 'dashboard'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        }); 

        // 2. Mostrar la secci√≥n activa con el display correcto
        const target = document.getElementById(t);
        if (target) {
            target.style.display = (t === 'registro') ? 'flex' : 'block'; 
        }

        // 3. Gestionar botones activos
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        const activeBtn = document.getElementById('btn-' + t);
        if (activeBtn) activeBtn.classList.add('active'); 

        // 4. L√ìGICA DE SIDEBAR (E, L, C)
        // --- L√ìGICA DE SIDEBAR ANIMADA ---
    const sidebar = document.getElementById('sidebar');
    if (t === 'dashboard' || t === 'registro') {
        sidebar.classList.add('hidden-sidebar'); // Se desliza hacia afuera
    } else {
        sidebar.classList.remove('hidden-sidebar'); // Regresa suavemente
    }

        // 5. Carga de datos
        if(t === 'dashboard') { 
            cargarDashboardDirecto(); 
        } else if(t !== 'registro') { 
            loadData(); 
        } 

        if(t === 'registro' && !document.getElementById('f_nombre').value) limpiarForm(); 
    }

    function filterGroup(g, el) { document.querySelectorAll('.filter-circle').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderAsistencia(g); renderCalendario(g); }
    function abrirFirma(name) { currentKidName = name; ctx.clearRect(0,0,canvas.width,canvas.height); document.getElementById('modalFirma').style.display = 'flex'; }
    async function confirmarAsistia() { await fetch(`${URL_APP}?action=asistencia&nombre=${encodeURIComponent(currentKidName)}&sesiones=-1`, { mode: 'no-cors' }); document.getElementById('modalFirma').style.display = 'none'; loadData(); }
    function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
    function enviarWA(n, r, w) { 
        const msg = `Buenas Tardes ${r.split(' ')[0]}, le saludamos de parte de KidOm, solamente para recordarle que ${n.split(' ')[0]} tiene su sesion en 1 hora. (No olvide su mapa y su termo)`; 
        window.open(`https://wa.me/${w}?text=${encodeURIComponent(msg)}`, '_blank'); 
    }

    function validarAcceso() { 
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;

        if(u === "KidOmAcademy" && p === "VisionFe2026") { 
            const overlay = document.getElementById('login-overlay');
            const card = document.querySelector('.login-card');
            card.classList.add('login-exit-anim');
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    document.getElementById('main-app-container').style.display = 'flex';
                    
                    // --- CORRECCI√ìN AQU√ç ---
                    // Forzamos que entre a Registro y esconda la sidebar de una vez
                    showTab('registro'); 
                    
                    loadData(); 
                    calcularTotales();
                }, 500);
            }, 500);
        } else {
            alert("El usuario/contrase√±a no es correcto, intentalo de nuevo.");
        }
    }

    document.getElementById('user').addEventListener('keypress', (e) => { if(e.key === 'Enter') validarAcceso(); });
    document.getElementById('pass').addEventListener('keypress', (e) => { if(e.key === 'Enter') validarAcceso(); });

    function cerrarSesion() {
        const overlay = document.getElementById('login-overlay');
        const card = document.querySelector('.login-card');
        document.getElementById('user').value = "";
        document.getElementById('pass').value = "";
        card.classList.remove('login-exit-anim');
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        document.getElementById('main-app-container').style.display = 'none';
        showTab('registro');
    }

    let canvas = document.getElementById('canvasFirma'), ctx = canvas.getContext('2d'), drawing = false;
    function startDrawing(e) { drawing = true; draw(e); }
    function stopDrawing() { drawing = false; ctx.beginPath(); }
    function draw(e) {
        if (!drawing) return;
        e.preventDefault(); 
        ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#2667ff';
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        let r = canvas.getBoundingClientRect();
        ctx.lineTo(clientX - r.left, clientY - r.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(clientX - r.left, clientY - r.top);
    }
    canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchstart', startDrawing); canvas.addEventListener('touchend', stopDrawing); canvas.addEventListener('touchmove', draw);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript,self.addEventListener(\'fetch\', function(event) {});');
    }

    function buscarEstudiante() {
        const texto = document.getElementById('inputBusqueda').value.toLowerCase().trim();
        const tarjetas = document.querySelectorAll('.card-asis');
        tarjetas.forEach(tarjeta => {
            const nombre = tarjeta.querySelector('.asis-info b').innerText.toLowerCase();
            tarjeta.style.display = nombre.includes(texto) ? 'flex' : 'none';
        });
    }

    let currentKidData = {};

    function abrirReporte(nombre) {
        const kid = allStudents.find(s => s.nombre === nombre);
        if(!kid) {
            alert("No se encontr√≥ la data del estudiante");
            return;
        }
        currentKidData = kid; 
        document.getElementById('rep_nombre_display').innerText = nombre.toUpperCase();
        document.getElementById('modalReporte').style.display = 'flex';
    }

    async function enviarReporteDefinitivo() {
        const btn = document.getElementById('btnEnviandoRep');
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ PROCESANDO REPORTE..."; btn.disabled = true;

        const query = `?action=generarReporte` + 
            `&nombre=${encodeURIComponent(currentKidData.nombre)}` +
            `&grupo=${encodeURIComponent(currentKidData.grupo)}` +
            `&correo=${encodeURIComponent(currentKidData.correoPadre)}` +
            `&enfoque=${document.getElementById('r_enfoque').value}` +
            `&disciplina=${document.getElementById('r_disciplina').value}` +
            `&liderazgo=${document.getElementById('r_liderazgo').value}` +
            `&autonomia=${document.getElementById('r_autonomia').value}` +
            `&fisico=${document.getElementById('r_fisico').value}` +
            `&equipo=${document.getElementById('r_equipo').value}` +
            `&publico=${document.getElementById('r_publico').value}` +
            `&respeto=${document.getElementById('r_respeto').value}` +
            `&energia=${document.getElementById('r_energia').value}` +
            `&frustracion=${document.getElementById('r_frustracion').value}`;

        try {
            await fetch(URL_APP + query, { method: 'GET', mode: 'no-cors' });
            alert("El reporte ha sido enviado exitosamente al representante.");
            cerrarModal('modalReporte');
        } catch(e) {
            alert("Proceso iniciado correctamente.");
            cerrarModal('modalReporte');
        } finally {
            btn.innerText = originalText; btn.disabled = false;
        }
    }

   function cargarDashboardDirecto() {
    // 1. Obtener el mes seleccionado del dropdown
    const mesSeleccionado = document.getElementById('select-mes-dashboard').value;
    
    let totalVentas = 0, contadorNi√±os = 0, meta = 4000;
    let mEfectivo = 0, mTransferencia = 0, mTarjeta = 0;
    let pPro = 0, pMax = 0, pElite = 0;
    let gExploradores = 0, gLideres = 0, gCampeones = 0;

    allStudents.forEach(est => {
        // Filtramos por el mes que el usuario eligi√≥ en el selector
        let mesFila = String(est.mes || "").trim().toLowerCase();
        
        if (mesFila === mesSeleccionado) {
            let valor = parseFloat(String(est.monto || "0").replace(/[^0-9.]/g, '')) || 0;
            totalVentas += valor;
            contadorNi√±os++;

            // Pago
            let met = String(est.metodoPago || "").trim().toLowerCase();
            if (met.includes("efectivo")) mEfectivo += valor;
            else if (met.includes("transferencia")) mTransferencia += valor;
            else if (met.includes("tarjeta") || met.includes("payphone")) mTarjeta += valor;

            // Planes
            let plan = String(est.plan || "").trim().toLowerCase();
            if (plan.includes("pro")) pPro++;
            else if (plan.includes("max")) pMax++;
            else if (plan.includes("elite")) pElite++;

            // Grupos (Basado en la columna de grupo)
            let grupo = String(est.grupo || "").trim().toLowerCase();
            if (grupo.includes("exploradores")) gExploradores++;
            else if (grupo.includes("lideres") || grupo.includes("l√≠deres")) gLideres++;
            else if (grupo.includes("campeones")) gCampeones++;
        }
    });

    // --- ACTUALIZAR UI ---
    document.getElementById('dash-total').innerText = '$' + totalVentas.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('dash-alumnos').innerText = contadorNi√±os;
    let promedio = contadorNi√±os > 0 ? (totalVentas / contadorNi√±os) : 0;
    document.getElementById('dash-promedio').innerText = '$' + promedio.toLocaleString('en-US', {minimumFractionDigits: 2});

    // Meta
    let porcMeta = Math.min((totalVentas / meta) * 100, 100);
    document.getElementById('bar-meta').style.width = porcMeta + "%";
    document.getElementById('txt-porcentaje-meta').innerText = porcMeta.toFixed(1) + "%";

    // Pagos
    document.getElementById('p-efe').innerText = '$' + mEfectivo.toLocaleString('en-US');
    document.getElementById('p-tra').innerText = '$' + mTransferencia.toLocaleString('en-US');
    document.getElementById('p-tar').innerText = '$' + mTarjeta.toLocaleString('en-US');

    // UI de Planes
    document.getElementById('txt-p-pro').innerText = pPro;
    document.getElementById('txt-p-max').innerText = pMax;
    document.getElementById('txt-p-elite').innerText = pElite;

    // UI de Grupos
    document.getElementById('txt-g-exploradores').innerText = gExploradores;
    document.getElementById('txt-g-lideres').innerText = gLideres;
    document.getElementById('txt-g-campeones').innerText = gCampeones;

    if(contadorNi√±os > 0) {
        // Barras de Planes
        document.getElementById('bar-p-pro').style.width = (pPro / contadorNi√±os * 100) + "%";
        document.getElementById('bar-p-max').style.width = (pMax / contadorNi√±os * 100) + "%";
        document.getElementById('bar-p-elite').style.width = (pElite / contadorNi√±os * 100) + "%";
        
        // Barras de Grupos
        document.getElementById('bar-g-exploradores').style.width = (gExploradores / contadorNi√±os * 100) + "%";
        document.getElementById('bar-g-lideres').style.width = (gLideres / contadorNi√±os * 100) + "%";
        document.getElementById('bar-g-campeones').style.width = (gCampeones / contadorNi√±os * 100) + "%";
    } else {
        // Resetear barras si no hay datos
        ["bar-p-pro","bar-p-max","bar-p-elite","bar-g-exploradores","bar-g-lideres","bar-g-campeones"].forEach(id => {
            document.getElementById(id).style.width = "0%";
        });
    }
}
</script>

<div class="modal-overlay" id="modalReporte">
    <div class="modal-box" style="max-width: 600px; max-height: 95vh; overflow: hidden; padding: 0; border-radius: 12px; border: 2px solid var(--blue); background: #ffffff;">
        <div style="background: var(--blue); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid #ffcc26;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="https://i.imgur.com/TffJPDG.png" style="height: 40px; width: auto; object-fit: contain; filter: brightness(0) invert(1);" alt="KiDOM Logo">
                <div style="width: 2px; height: 25px; background: rgba(255,255,255,0.3);"></div>
                <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase;">EVALUACION KIDOM</h3>
            </div>
            <p id="rep_nombre_display" style="font-weight: 900; color: #ffffff; margin: 0; font-size: 18px; text-transform: uppercase;"></p>
        </div>

        <div style="padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: left;">
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Enfoque y Reglas</label><input type="number" id="r_enfoque" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Disciplina y Control</label><input type="number" id="r_disciplina" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Liderazgo y Servicio</label><input type="number" id="r_liderazgo" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Autonom√≠a en Clase</label><input type="number" id="r_autonomia" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">F√≠sico y Habilidades</label><input type="number" id="r_fisico" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Trabajo en Equipo</label><input type="number" id="r_equipo" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Hablar en P√∫blico</label><input type="number" id="r_publico" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Respeto KidOm</label><input type="number" id="r_respeto" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Energ√≠a en Clase</label><input type="number" id="r_energia" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px; grid-column: span 3;"><label class="label-kidom" style="font-size: 10px; font-weight: 800;">Frustraci√≥n y Emociones</label><input type="number" id="r_frustracion" class="select-kidom" min="1" max="10" value="10" style="width: 100%;"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="btnEnviandoRep" style="flex: 2; padding: 12px; border-radius: 8px; border: none; font-weight: 900; background: var(--blue); color: white; cursor: pointer; text-transform: uppercase; font-size: 12px;" onclick="enviarReporteDefinitivo()">ENVIAR DATOS Y GENERAR REPORTE PDF</button>
                <button style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 900; background: #eee; cursor: pointer; font-size: 12px;" onclick="cerrarModal('modalReporte')">CANCELAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalHorarios">
    <div class="modal-box">
        <h3>SELECCI√ìN DE SESIONES</h3>
        <select id="sel-horario-modal" class="select-modal-asis" multiple onchange="sincronizarHorarios()"></select>
        <button style="width:100%; padding:15px; border-radius:12px; border:none; font-weight:900; background:var(--yellow); color:var(--dark); cursor:pointer; margin-top:20px;" onclick="cerrarModal('modalHorarios')">CONFIRMAR HORARIOS</button>
    </div>
</div>
</body>
</html>